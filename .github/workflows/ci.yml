name: CI Build

on:
  push:
    branches:
      - master
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Mod
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          distribution: graalvm
          java-version: '25'
          cache: gradle
          cache-dependency-path: |
            **/*.gradle*
            **/buildscript.properties
            **/gradle-wrapper.properties
            **/gradle.lockfile
            src/main/resources/hbm_at.cfg

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew build --no-daemon

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.repository.name }}
          path: |
            build/libs/**
            !build/libs/**/*-downgraded.jar
          if-no-files-found: error

      - name: Run server
        run: |
          set -euo pipefail

          mkdir -p run/server
          echo "eula=true" > run/server/eula.txt

          # Set a constant seed with a village at spawn
          printf "level-seed=-6202107849386030209\nonline-mode=true\n" > run/server/server.properties

          echo "stop" > run/server/stop.txt
          set +e
          timeout 120s ./gradlew runServer --no-daemon --stacktrace < run/server/stop.txt 2>&1 | tee server.log
          code=${PIPESTATUS[0]}
          set -e

          if [ "$code" -ne 0 ] && [ "$code" -ne 124 ]; then
            echo "runServer exited with code $code"
            exit "$code"
          fi

      - name: Validate server run
        run: |
          set -euo pipefail

          RUNDIR="run/server"
          CRASH="crash-reports"
          SERVERLOG="$RUNDIR/logs/latest.log"

          shopt -s nullglob

          crash_reports=("$RUNDIR/$CRASH/crash"*.txt)

          if [ "${#crash_reports[@]}" -gt 0 ]; then
            latest_crash_report="${crash_reports[-1]}"
            {
              printf 'Latest crash report detected %s:\n' "${latest_crash_report##*/}"
              cat "$latest_crash_report"
            } >&2
            exit 1
          fi

          if [ -f "$SERVERLOG" ]; then
            if grep -qF 'Fatal errors were detected' "$SERVERLOG"; then
              {
                printf 'Fatal errors detected:\n'
                cat "$SERVERLOG"
              } >&2
              exit 1
            fi

            if grep -qF 'The state engine was in incorrect state ERRORED and forced into state SERVER_STOPPED' \
              "$SERVERLOG"; then
              {
                printf 'Server force stopped:\n'
                cat "$SERVERLOG"
              } >&2
              exit 1
            fi

            if grep -qF 'Exception stopping the server' "$SERVERLOG"; then
              {
                printf "Server didn't shut down cleanly:\n"
                cat "$SERVERLOG"
              } >&2
              exit 1
            fi

            if ! grep -qP '.+Done \(.+\)\! For help, type "help" or "\?"' "$SERVERLOG"; then
              {
                printf 'Server did not finish startup:\n'
                cat "$SERVERLOG"
              } >&2
              exit 1
            fi
          else
            echo "No latest.log found at $SERVERLOG (server may not have fully started)."
          fi

          echo 'No crash reports detected'
